import{_ as s,a as n,a2 as e,o as i}from"./chunks/framework.DAlL-BGO.js";const b=JSON.parse('{"title":"","description":"","frontmatter":{"lastUpdated":"2023-12-18 22:22"},"headers":[],"relativePath":"pages/安装手册/Fail2ban的安装和使用.md","filePath":"pages/安装手册/Fail2ban的安装和使用.md","lastUpdated":1733806965000}'),l={name:"pages/安装手册/Fail2ban的安装和使用.md"};function p(t,a,c,o,d,r){return i(),n("div",null,a[0]||(a[0]=[e(`<h2 id="_1-简介" tabindex="-1">1. 简介 <a class="header-anchor" href="#_1-简介" aria-label="Permalink to &quot;1. 简介&quot;">​</a></h2><p>CentOS 中使用<code>fail2ban</code>和<code>firewalld</code>限制IP拦截cc攻击</p><h2 id="_2-安装和启动" tabindex="-1">2. 安装和启动 <a class="header-anchor" href="#_2-安装和启动" aria-label="Permalink to &quot;2. 安装和启动&quot;">​</a></h2><ul><li>安装</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ yum -y install fail2ban</span></span></code></pre></div><p>安装后可以使用以下命令查看版本</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ fail2ban-client -V</span></span>
<span class="line"><span>$ fail2ban-server -V</span></span></code></pre></div><p>显示如下</p><blockquote><p>Fail2Ban v0.9.7 Copyright (c) 2004-2008 Cyril Jaquier, 2008- Fail2Ban Contributors Copyright of modifications held by their respective authors. Licensed under the GNU General Public License v2 (GPL).</p><p>Written by Cyril Jaquier <a href="mailto:cyril.jaquier@fail2ban.org" target="_blank" rel="noreferrer">cyril.jaquier@fail2ban.org</a>. Many contributions by Yaroslav O. Halchenko <a href="mailto:debian@onerussian.com" target="_blank" rel="noreferrer">debian@onerussian.com</a>.</p></blockquote><ul><li>停止</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ systemctl stop fail2ban</span></span></code></pre></div><ul><li>启动</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ systemctl start fail2ban</span></span></code></pre></div><ul><li>重启</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ systemctl restart fail2ban</span></span></code></pre></div><ul><li>开机启动</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ systemctl enable fail2ban</span></span></code></pre></div><h2 id="_3-配置" tabindex="-1">3. 配置 <a class="header-anchor" href="#_3-配置" aria-label="Permalink to &quot;3. 配置&quot;">​</a></h2><p><code>fail2ban</code>安装后有两个程序，<code>fail2ban-server</code> 和 <code>fail2ban-client</code>,对应的主配置文件是<code>fail2ban.conf</code> 和 <code>jail.conf</code>。本次主要是修改 <code>fail2ban-client</code>配置。</p><p><code>fail2ban</code>的<code>.conf</code>配置文件都是可以被<code>.local</code>覆盖，所以配置方式建议是添加<code>.local</code>文件，不修改原来的配置文件。</p><ul><li>jail.local 配置</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ vim /etc/fail2ban/jail.local</span></span></code></pre></div><p>添加默认配置</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[DEFAULT]</span></span>
<span class="line"><span>ignoreip = 127.0.0.1/8</span></span>
<span class="line"><span>bantime  = 86400</span></span>
<span class="line"><span>findtime = 600</span></span>
<span class="line"><span>maxretry = 5</span></span>
<span class="line"><span>banaction = firewallcmd-ipset</span></span>
<span class="line"><span>action = %(action_mwl)s</span></span></code></pre></div><p>配置说明</p><blockquote><p>ignoreip：白名单，不拦截，多个使用<code>,</code>分隔 bantime：拦截后禁止访问的时间，单位：秒 findtime：检查的时间访问，单位：秒 maxretry：最大失败次数, 在检查时间内达到次数就拦截 banaction：屏蔽ip的方法，<code>firewallcmd-ipset</code>使用<code>fiewallld</code>屏蔽</p></blockquote><ul><li>添加nginx拦截规则</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ vim /etc/fail2ban/filter.d/nginx-cc.conf</span></span></code></pre></div><p>配置如下</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[Definition]</span></span>
<span class="line"><span>failregex = &lt;HOST&gt; -.*- .*HTTP/1.* .* .*$</span></span>
<span class="line"><span>ignoreregex =</span></span></code></pre></div><p>配置说明</p><blockquote><p>failregex ：拦截的正则规则, 可以使用 <code>&lt;HOST&gt;</code> 匹配主机名和IP地址； <code>&lt;HOST&gt;</code> 是正则表达式 <code>(?:::f{4,6}:)?(?P&lt;host&gt;\\S+)</code>的别名</p></blockquote><ul><li>添加nginx-cc配置到<code>jail.local中</code></li></ul><p>在<code>jail.local</code>中添加配置</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[nginx-cc]</span></span>
<span class="line"><span>enabled = true</span></span>
<span class="line"><span>port = http,https</span></span>
<span class="line"><span>filter = nginx-cc</span></span>
<span class="line"><span>action = %(action_mwl)s</span></span>
<span class="line"><span>maxretry = 200</span></span>
<span class="line"><span>findtime = 10</span></span>
<span class="line"><span>bantime = 86400</span></span>
<span class="line"><span># 说明注释</span></span>
<span class="line"><span>logpath = /var/log/nginx/access.log</span></span></code></pre></div><p>以上配置是检查 “20秒之内访问次数达到200次就拦截该IP”。其它的配置说明如下：</p><blockquote><p>enabled ：是否开启检测 port：检查的端口 maxretry：最大失败次数, 在检查时间内达到次数就拦截 bantime：拦截后禁止访问的时间，单位：秒 findtime：检查的时间访问，单位：秒 logpath: 扫描的日志文件，<code>fail2ban</code>按行扫描此文件，根据filter规则匹配失败的项目并统计</p></blockquote><p><strong>注意:</strong> 配置文件文件可以换行添加注释，但是不能在配置项后面跟注释，例如以下的注释是不允许的，<code>failban</code>会检查配置无效，将 <code>bantime</code>设置成<code>None</code>。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>bantime = 86400 # 这里不能写注释</span></span></code></pre></div><ul><li>加载配置</li></ul><p>重载配置是其生效</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ fail2ban-client reload</span></span></code></pre></div><h2 id="_4-其它命令" tabindex="-1">4. 其它命令 <a class="header-anchor" href="#_4-其它命令" aria-label="Permalink to &quot;4. 其它命令&quot;">​</a></h2><ul><li>查看拦截状态</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ fail2ban-client status nginx-cc</span></span></code></pre></div><p>结果如下， <code>Banned IP list</code>就是被拦截的IP</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Status for the jail: nginx-cc</span></span>
<span class="line"><span>|- Filter</span></span>
<span class="line"><span>|  |- Currently failed: 1</span></span>
<span class="line"><span>|  |- Total failed:     100</span></span>
<span class="line"><span>|  \`- File list:        /var/log/nginx/access.log</span></span>
<span class="line"><span>\`- Actions</span></span>
<span class="line"><span>   |- Currently banned: 3</span></span>
<span class="line"><span>   |- Total banned:     3</span></span>
<span class="line"><span>   \`- Banned IP list:   101.2.2.1 101.2.2.3 101.2.2.4</span></span></code></pre></div><ul><li>手动拦截IP</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ fail2ban-client set nginx-cc banip 101.2.2.1</span></span></code></pre></div><ul><li>解除拦截的IP</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ fail2ban-client set nginx-cc unbanip 101.2.2.1</span></span></code></pre></div><ul><li>检查配置</li></ul><p>修改后可以先使用以下命令检查配置是否有误</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ fail2ban-client -d</span></span></code></pre></div><ul><li>正则规则检查</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>$ fail2ban-regex /var/log/nginx/access.log &quot;&lt;HOST&gt; -.*- .*HTTP/1.* .* .*$&quot;</span></span></code></pre></div><ul><li>根据配置文件检查</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>fail2ban-regex /var/log/nginx/access.log /etc/fail2ban/filter.d/nginx-cc.conf</span></span></code></pre></div>`,58)]))}const u=s(l,[["render",p]]);export{b as __pageData,u as default};
