import{_ as a,a as i,a2 as e,o as t}from"./chunks/framework.DAlL-BGO.js";const r=JSON.parse('{"title":"使用acme.sh生成https证书","description":"","frontmatter":{"title":"使用acme.sh生成https证书","lastUpdated":"2024-12-03 15:43"},"headers":[],"relativePath":"install/acme-sh-https.md","filePath":"install/acme-sh-https.md","lastUpdated":1733806965000}'),h={name:"install/acme-sh-https.md"};function l(n,s,p,c,d,k){return t(),i("div",null,s[0]||(s[0]=[e('<h3 id="一、安装" tabindex="-1">一、安装 <a class="header-anchor" href="#一、安装" aria-label="Permalink to &quot;一、安装&quot;">​</a></h3><p>参考 <a href="https://github.com/Neilpang/acme.sh/wiki/%E8%AF%B4%E6%98%8E" target="_blank" rel="noreferrer">acme.sh文档</a></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> curl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  https://get.acme.sh</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sh</span></span></code></pre></div><p>无法下载时可以使用下面的代理方式：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> curl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://mirror.ghproxy.com/https://raw.githubusercontent.com/Neilpang/acme.sh/master/acme.sh</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INSTALLONLINE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">1</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  sh</span></span></code></pre></div><p>使用命令<code> source ~/.bashrc</code>让alias生效，或者再次执行</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> alias</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> acme.sh=~/.acme.sh/acme.sh</span></span></code></pre></div><h3 id="二、添加dnsapi密钥" tabindex="-1">二、添加DNSAPI密钥 <a class="header-anchor" href="#二、添加dnsapi密钥" aria-label="Permalink to &quot;二、添加DNSAPI密钥&quot;">​</a></h3><p>我使用阿里云的域名，所以直接先添加阿里云的dnsapi, 登录阿里云控制台-头像-accesskeys, 或者登录后直接打开 <a href="https://ak-console.aliyun.com/#/accesskey" target="_blank" rel="noreferrer">链接</a>，添加并获取<code>AccessKeyID</code>和<code>AccessKeySecret</code>,存在旧的也可以直接使用。</p><p>其他类型的可以参考<a href="https://github.com/Neilpang/acme.sh/wiki/dnsapi" target="_blank" rel="noreferrer">dnsapi文档 </a></p><h3 id="三、生成证书" tabindex="-1">三、生成证书 <a class="header-anchor" href="#三、生成证书" aria-label="Permalink to &quot;三、生成证书&quot;">​</a></h3><p>使用阿里云的dns,所以下面的dns参数是<code>dns_ali</code>, 例如我们申请<code>zqyu.com</code>这个域名的泛域名证书</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> export</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Ali_Key=&quot;[参数是上面申请的AccessKeyID]&quot;</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> export</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Ali_Secret=&quot;[参数是上面申请的AccessKeySecret]&quot;</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> acme.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --issue</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --dns</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dns_ali</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zqyu.com</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.zqyu.com</span></span></code></pre></div><p>如果下载失败可以使用 <code>--debug</code>参数打印更多的信息，例如</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> acme.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --issue</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --dns</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dns_ali</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zqyu.com-d</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.zqyu.com</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --debug</span></span></code></pre></div><p>等待证书下载并保存，<code>acme.sh</code> 用到的所有文件都放在路径 <code>~/.acme.sh/</code>, 下载的证书也全部放在这里。</p><h3 id="四、安装证书" tabindex="-1">四、安装证书 <a class="header-anchor" href="#四、安装证书" aria-label="Permalink to &quot;四、安装证书&quot;">​</a></h3><p>官方文档建议不要直接使用这个目录下的文件，所以使用命令将生成的证书安装到其他的目录。</p><p>例如nginx使用的证书，使用下面的命令将证书复制到<code> /etc/letsencrypt/zqyu.com/nginx</code>目录中</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> acme.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --install-cert</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zqyu.com</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">--key-file       </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/etc/letsencrypt/zqyu.com/nginx/key.pem</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  \\</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">--fullchain-file </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/etc/letsencrypt/zqyu.com/nginx/cert.pem</span></span></code></pre></div><p>nginx中使用证书</p><blockquote><p>ssl_certificate /etc/letsencrypt/zqyu.com/nginx/cert.pem; ssl_certificate_key /etc/letsencrypt/zqyu.com/nginx/key.pem;</p></blockquote><p>重新加载nginx配置</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nginx</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> reload</span></span></code></pre></div><h3 id="五、证书更新" tabindex="-1">五、证书更新 <a class="header-anchor" href="#五、证书更新" aria-label="Permalink to &quot;五、证书更新&quot;">​</a></h3><p><code>acme.sh</code> 安装时默认添加了一个自动更新证书的定时任务</p><blockquote><p>57 0 * * * &quot;~/.acme.sh&quot;/acme.sh --cron --home &quot;~/.acme.sh&quot; &gt; /dev/null</p></blockquote><p>所以证书是可以自动更新了,上面的dnsapi账号信息保存到了<code>~/.acme.sh/account.conf</code>文件中，安装的目录保存到了<code>~/.acme.sh/zqyu.com/zqyu.com.conf</code>,自动更新时会读取这些信息。</p><p>更新证书之后需要重新加载nginx配置</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nginx</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> reload</span></span></code></pre></div><p>可以将命令也加到定时任务里面</p><blockquote><p>57 0 * * * &quot;~/.acme.sh&quot;/acme.sh --cron --home &quot;~/.acme.sh&quot; &gt; /dev/null &amp;&amp; nginx -s reload</p></blockquote><h3 id="六、-acme-sh-更新" tabindex="-1">六、 <code>acme.sh</code> 更新 <a class="header-anchor" href="#六、-acme-sh-更新" aria-label="Permalink to &quot;六、 `acme.sh` 更新&quot;">​</a></h3><p>手动更新</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> acme.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --upgrade</span></span></code></pre></div><p>设置自动更新</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">acme.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --upgrade</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --auto-upgrade</span></span></code></pre></div><p>取消自动更新</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">acme.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --upgrade</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --auto-upgrade</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span></code></pre></div><h3 id="七、-acme-sh-卸载" tabindex="-1">七、 <code>acme.sh</code> 卸载 <a class="header-anchor" href="#七、-acme-sh-卸载" aria-label="Permalink to &quot;七、 `acme.sh` 卸载&quot;">​</a></h3><ol><li>删除文件夹 <code>~/.acme.sh</code></li><li>使用 <code>crontab -e</code> 删除生成的定时任务</li><li>删除别名 <code>unalias acme.sh</code></li><li>删除 <code>~/.bashrc</code> 中的 <code>. &quot;/root/.acme.sh/acme.sh.env&quot;</code></li></ol>',41)]))}const g=a(h,[["render",l]]);export{r as __pageData,g as default};
